# Smoking‑Free Bot

Телеграм‑бот для сообщества отказа от курения. Взаимодействие — через inline‑кнопки; в группе доступна одна команда для публикации рейтинга.

## Что умеет
- Регистрация через ЛС по мастер‑шагам (дата последней сигареты, стоимость пачки)
- Проверка членства в целевой группе
- Назначение «микро‑админки» (право закреплять сообщения) и короткого кастом‑тайтла (≤ 16 символов)
- Ежедневный пост ТОП‑10 в заданное время и персональные утренние напоминания
- Единственная групповая команда: `/top_members`

## Технологии
- Python 3.11+, aiogram 3 (long‑polling)
- APScheduler (cron)
- Postgres (по умолчанию; SQLite как упрощённый вариант)
- Слои: transport (bot), domain, storage, scheduler, security

## Быстрый старт (Docker)
1) Скопируйте шаблон окружения и заполните значения:
   ```bash
   cp env.example .env
   ```
2) Запуск сервисов:
   ```bash
   docker compose up -d --build
   ```
3) Проверка логов бота:
   ```bash
   docker compose logs -f bot
   ```

## Конфигурация
Все настройки считываются из переменных окружения. Используйте `env.example` как ориентир.
- `BOT_TOKEN` — токен бота
- `GROUP_CHAT_ID` — ID группы (обычно отрицательное число)
- `TOPIC_ID` — ID топика (опционально, для групп с темами)
- `TZ` — таймзона, например `Europe/Moscow`
- `DAILY_POST_HOUR`, `DAILY_POST_MINUTE` — время ежедневных задач
- `OWNER_USER_ID` — ID владельца/админа бота
- `DATABASE_URL` — строка подключения к БД, например `postgresql+asyncpg://user:password@host:5432/db`
- `CALLBACK_SECRET` — секрет для подписи callback‑данных

## Команды и сценарии
- В ЛС:
  - `/start` — главное меню с кнопками
  - «Зарегистрироваться / Обновить дату» — пошаговый мастер
  - «Моя статистика» — стаж, экономия, ранг
  - «Напоминания: Вкл/Выкл» — персональные уведомления
  - «Выйти из рейтинга» — исключение из ТОПа
- В группе:
  - `/top_members` — публикация ТОП‑10 с кнопками: «Мой статус в ЛС», «Обновить ТОП», «Закрепить»

## Ежедневные задачи
- Пересчёт стажа всех участников
- Обновление кастом‑тайтлов у администраторов
- Публикация ТОП‑10 в группе
- Персональные утренние сообщения для тех, у кого включены напоминания

## Права и безопасность
- Боту рекомендуются права: публикация сообщений, закрепление, назначение админов (для тайтлов)
- «Микро‑админам» выдаётся только право закреплять сообщения
- Callback‑запросы подписываются и валидаются
- Логи без лишних персональных данных

## База данных
Минимальные таблицы:
- `users(user_id, username, full_name, quit_date, pack_price, is_member, is_admin_promoted, notifications, created_at, updated_at)`
- `metrics(user_id, days, saved_money, updated_at)`
- `audit(id, user_id, action, meta_json, created_at)`
- `top_posts(chat_id, message_id, updated_at)` — служебная таблица для обновления поста рейтинга

## Архитектура проекта
- `app/transport` — бот, роутеры и обработчики
- `app/domain` — прикладная логика (расчёт стажа, тайтлы, ранги)
- `app/storage` (`app/db`) — модели и репозитории
- `app/scheduler` — планировщик задач
- `app/security` — утилиты безопасности (HMAC)

## Локальная разработка (без Docker)
```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\Activate.ps1
pip install -r requirements.txt
cp env.example .env  # заполните значения
python main.py
```

— Готово к деплою в Docker и на любой сервер с Linux/Docker. Секреты хранятся в переменных окружения.
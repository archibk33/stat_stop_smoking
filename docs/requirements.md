# Smoking-Free Bot ‚Äî Requirements (Inline Buttons)

## 0. Summary
–ë–æ—Ç –¥–ª—è Telegram-–≥—Ä—É–ø–ø—ã –æ—Ç–∫–∞–∑–∞ –æ—Ç –∫—É—Ä–µ–Ω–∏—è. –í—Å—ë –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ‚Äî —á–µ—Ä–µ–∑ **inline-–∫–Ω–æ–ø–∫–∏ –ø–æ–¥ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏** (–Ω–∏–∫–∞–∫–∏—Ö ReplyKeyboard). –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: **/top_members** ‚Äî –≤—ã–≤–æ–¥ –¢–û–ü-10 –≤ –≥—Ä—É–ø–ø–µ. –ë–æ—Ç:
- —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∞ —á–µ—Ä–µ–∑ –õ–°,
- –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á–ª–µ–Ω—Å—Ç–≤–æ –≤ —Ü–µ–ª–µ–≤–æ–π –≥—Ä—É–ø–ø–µ,
- –ø–æ–≤—ã—à–∞–µ—Ç –¥–æ ¬´–º–∏–∫—Ä–æ-–∞–¥–º–∏–Ω–∞¬ª —Å –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –ø—Ä–∞–≤–æ–º `can_pin_messages`,
- —Å—Ç–∞–≤–∏—Ç/–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–∞–π—Ç–ª –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ (‚â§16 —Å–∏–º–≤–æ–ª–æ–≤, –±–µ–∑ —ç–º–æ–¥–∑–∏),
- –ø—É–±–ª–∏–∫—É–µ—Ç –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –¢–û–ü –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –±—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏.

---

## 1. Functional Requirements

### 1.1 –ì–ª–∞–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è (–õ–°, inline-–∫–Ω–æ–ø–∫–∏)
–ü–æ—Å–ª–µ `/start` –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ¬´–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é¬ª —Å –∫–Ω–æ–ø–∫–∞–º–∏:
- **‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è / –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É** ‚Äî –ø–æ—à–∞–≥–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä.
- **üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** ‚Äî –¥–Ω–∏ –±–µ–∑ —Å–∏–≥–∞—Ä–µ—Ç, —ç–∫–æ–Ω–æ–º–∏—è.
- **üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: –í–∫–ª/–í—ã–∫–ª** ‚Äî –ª–∏—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Ç—Ä–æ–º —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º.
- **‚Ü©Ô∏è –í—ã–π—Ç–∏ –∏–∑ —Ä–µ–π—Ç–∏–Ω–≥–∞** ‚Äî –∏—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –¢–û–ü–∞ –∏ (–æ–ø—Ü.) —Å–Ω—è—Ç—å –∞–¥–º–∏–Ω–∫—É.

–í—Å–µ —ç–∫—Ä–∞–Ω—ã ‚Äî —Ç–æ–ª—å–∫–æ inline-–∫–Ω–æ–ø–∫–∏, –∫–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤—Å–µ–≥–¥–∞.

### 1.2 –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–ª–µ–Ω—Å—Ç–≤–∞
- –ü–µ—Ä–µ–¥ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ –ª—é–±—ã–º–∏ –≥—Ä—É–ø–ø–æ–≤—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏ –±–æ—Ç –≤—ã–∑—ã–≤–∞–µ—Ç `getChatMember(GROUP_CHAT_ID, user_id)`.
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å **–Ω–µ** —Å–æ—Å—Ç–æ–∏—Ç –≤ –≥—Ä—É–ø–ø–µ ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å:
  - **üîó –í—Å—Ç—É–ø–∏—Ç—å** (—Å—Å—ã–ª–∫–∞/–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è),
  - **üîÅ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–Ω–æ–≤–∞**.

### 1.3 –ú–∞—Å—Ç–µ—Ä —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
- **–ò–º—è**: –∫–Ω–æ–ø–∫–∏ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Telegram name** / **–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å**.
- **–î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–∏–≥–∞—Ä–µ—Ç—ã**:
  - –ö–Ω–æ–ø–∫–∏: **–°–µ–≥–æ–¥–Ω—è**, **–í—á–µ—Ä–∞**, **3 –¥–Ω—è –Ω–∞–∑–∞–¥**, **7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥**, **–î—Ä—É–≥–∞—è –¥–∞—Ç–∞**.
  - –ü—Ä–∏ ¬´–î—Ä—É–≥–∞—è –¥–∞—Ç–∞¬ª ‚Äî –≤–≤–æ–¥ —Ç–µ–∫—Å—Ç–æ–º `–ì–û–î-–ú–ï–°–Ø–¶-–î–ï–ù–¨ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2025-01-31)` (–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π –≤–≤–æ–¥ –≤ –º–∞—Å—Ç–µ—Ä–µ).
- **–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–∞—á–∫–∏**:
  - –ö–Ω–æ–ø–∫–∏: **200 / 250 / 300 / –î—Ä—É–≥–∞—è**; –ø—Ä–∏ ¬´–î—Ä—É–≥–∞—è¬ª ‚Äî –≤–≤–æ–¥ —á–∏—Å–ª–∞.
- **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ**: —ç–∫—Ä–∞–Ω —Å —Ä–µ–∑—é–º–µ –∏ –∫–Ω–æ–ø–∫–∞–º–∏ **–°–æ—Ö—Ä–∞–Ω–∏—Ç—å** / **–û—Ç–º–µ–Ω–∞**.

–ü–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—é:
- `promoteChatMember` —Å **–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏** (—Ç–æ–ª—å–∫–æ `can_pin_messages=true`, –æ—Å—Ç–∞–ª—å–Ω–æ–µ ‚Äî `false`).
- `setChatAdministratorCustomTitle` —Å –∫—Ä–∞—Ç–∫–∏–º —Ç–∞–π—Ç–ª–æ–º (—Å–º. 1.6).
- –û—Ç–≤–µ—Ç —Å –∫–Ω–æ–ø–∫–∞–º–∏: **üìä –ú–æ—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞**, **üèÜ –¢–û–ü-10**, **‚Ü©Ô∏è –ú–µ–Ω—é**.

### 1.4 –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –≤ –≥—Ä—É–ø–ø–µ
- **/top_members** ‚Äî –ø—É–±–ª–∏–∫—É–µ—Ç –¢–û–ü-10 —Å—Ç–∞–∂–∞ (ü•á/ü•à/ü•â –≤ —Ç–µ–∫—Å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è).
- –ü–æ–¥ –ø–æ—Å—Ç–æ–º ‚Äî inline-–∫–Ω–æ–ø–∫–∏:
  - **üì• –ú–æ–π —Å—Ç–∞—Ç—É—Å –≤ –õ–°** (deep-link `t.me/<bot>?start=me`),
  - **üîÑ –û–±–Ω–æ–≤–∏—Ç—å –¢–û–ü** (–¥–æ—Å—Ç—É–ø–Ω–∞ –∞–¥–º–∏–Ω–∞–º/–≤–ª–∞–¥–µ–ª—å—Ü—É –±–æ—Ç–∞),
  - **üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å** (–µ—Å–ª–∏ —É –±–æ—Ç–∞ –µ—Å—Ç—å –ø—Ä–∞–≤–æ –ø–∏–Ω–∏—Ç—å).

### 1.5 –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ (09:00, TZ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
- –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å—Ç–∞–∂ (–¥–Ω–∏) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞.
- –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–µ —Ç–∞–π—Ç–ª—ã `setChatAdministratorCustomTitle`.
- –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ—Å—Ç —Å –¢–û–ü-10 –≤ –≥—Ä—É–ø–ø–µ (—Å –∫–Ω–æ–ø–∫–∞–º–∏, —Å–º. 1.4).
- –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤–∫–ª—é—á–µ–Ω—ã –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ –õ–° –µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å.

### 1.6 –§–æ—Ä–º–∞—Ç –∫–∞—Å—Ç–æ–º-—Ç–∞–π—Ç–ª–∞
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: –¥–ª–∏–Ω–∞ 0‚Äì16 —Å–∏–º–≤–æ–ª–æ–≤, **—ç–º–æ–¥–∑–∏ –Ω–µ–ª—å–∑—è**.
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã: `55 –¥–Ω–µ–π`, `55d`, `–±–µ–∑ —Å–∏–≥ 55–¥`.
- –í–∞–ª–∏–¥–∞—Ç–æ—Ä –æ–±—è–∑–∞–Ω —É–∫–æ—Ä–∞—á–∏–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞.

### 1.7 –í—ã—Ö–æ–¥/—É–¥–∞–ª–µ–Ω–∏–µ
- –ö–Ω–æ–ø–∫–∞ **‚Ü©Ô∏è –í—ã–π—Ç–∏ –∏–∑ —Ä–µ–π—Ç–∏–Ω–≥–∞**:
  - –∏—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –¢–û–ü–∞,
  - (–æ–ø—Ü.) `promote=false` ‚Äî —Å–Ω—è—Ç—å –∞–¥–º–∏–Ω–∫—É,
  - —É–¥–∞–ª–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ç–∞–π—Ç–ª (–∏–ª–∏ –ø–æ–Ω–∏–∂–µ–Ω–∏–µ —Ä–æ–ª–∏ —Å–±—Ä–æ—Å–∏—Ç –µ–≥–æ).
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–∫–∏–Ω—É–ª –≥—Ä—É–ø–ø—É ‚Äî –Ω–æ—á–Ω–æ–π/—É—Ç—Ä–µ–Ω–Ω–∏–π –¥–∂–æ–± —á–∏—Å—Ç–∏—Ç –∑–∞–ø–∏—Å–∏, –ø—Ä–∞–≤–∞ –∏ –∏—Å–∫–ª—é—á–∞–µ—Ç –∏–∑ –¢–û–ü–∞.

### 1.8 –ê–Ω—Ç–∏-–∞–±—å—é–∑
- Rate limit –Ω–∞ –∫–ª–∏–∫–∏ (per-user/per-action).
- –ü–æ–¥–ø–∏—Å—å callback‚Äô–æ–≤: `callback.from_user.id` –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å `uid` –≤ `callback_data`.
- –í—Å–µ –æ–ø–∞—Å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–æ–π **–î–∞/–ù–µ—Ç**.

---

## 2. Non-Functional Requirements

### 2.1 Security
- –ë–æ—Ç ‚Äî –∞–¥–º–∏–Ω –≥—Ä—É–ø–ø—ã —Ç–æ–ª—å–∫–æ —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ (–ø–æ—Å—Ç–∏—Ç—å, –ø–∏–Ω–∏—Ç—å, `can_promote_members`).
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é-¬´–º–∏–∫—Ä–æ-–∞–¥–º–∏–Ω—É¬ª –≤—ã–¥–∞—ë—Ç—Å—è —Ç–æ–ª—å–∫–æ `can_pin_messages=true`.
- –í–∞–ª–∏–¥–∞—Ü–∏—è callback‚Äô–æ–≤: `uid` + HMAC –≤ `callback_data`; –æ—Ç–∫–ª–æ–Ω—è—Ç—å —á—É–∂–∏–µ –∫–ª–∏–∫–∏.
- –¢–æ–∫–µ–Ω/—Å–µ–∫—Ä–µ—Ç—ã ‚Äî —Ç–æ–ª—å–∫–æ ENV/—Å–µ–∫—Ä–µ—Ç-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
- –õ–æ–≥–∏ ‚Äî –±–µ–∑ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ username –ø–æ –∂–µ–ª–∞–Ω–∏—é).

### 2.2 Reliability
- –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ (APScheduler) ‚Äî cron 09:00 –≤ –∑–∞–¥–∞–Ω–Ω–æ–π TZ.
- –ü–æ–≤—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ Telegram API –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö (exponential backoff).
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å: –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π—Ç–ª–æ–≤/–ø–æ—Å—Ç–æ–≤ –Ω–µ –ª–æ–º–∞—é—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ.

### 2.3 Performance
- –î–æ 500 –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:
  - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¢–û–ü–∞ ‚â§ 300 –º—Å,
  - –º–∞—Å—Å–æ–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π—Ç–ª–æ–≤ ‚â§ 60 —Å–µ–∫.
- –•—Ä–∞–Ω–∏–ª–∏—â–µ: Postgres.

### 2.4 Maintainability
- –°–ª–æ–∏: `transport(bot)`, `domain`, `storage`, `scheduler`, `security`.
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ `.env`.
- –¢–∏–ø–∏–∑–∞—Ü–∏—è (mypy/pyright), –ª–∏–Ω—Ç–µ—Ä (ruff), —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ.

### 2.5 Usability
- –í—Å–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ ‚Äî —á–µ—Ä–µ–∑ inline-–∫–Ω–æ–ø–∫–∏ (–æ–¥–Ω–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ —ç–∫—Ä–∞–Ω).
- –ö–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥¬ª –≤ –∫–∞–∂–¥–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏.
- –¢–µ–∫—Å—Ç—ã –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã (RU), –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å.

---

## 3. Data Model

**users**  
- `user_id PK`, `username`, `full_name`,  
- `quit_date DATE`, `pack_price NUMERIC`,  
- `is_member BOOL`, `is_admin_promoted BOOL`,  
- `notifications BOOL`,  
- `created_at`, `updated_at`.

**metrics**  
- `user_id FK`, `days INT`, `saved_money NUMERIC`, `updated_at`.

**audit**  
- `id PK`, `user_id`, `action`, `meta_json`, `created_at`.

---

## 4. Callback Protocol (–ø—Ä–∏–º–µ—Ä)
- `cb:menu:<uid>:<hmac>`
- `cb:reg:start:<uid>:<hmac>`
- `cb:reg:date:<preset|custom>:<uid>:<hmac>`
- `cb:reg:price:<preset|custom>:<uid>:<hmac>`
- `cb:reg:confirm:<yes|no>:<uid>:<hmac>`
- `cb:stats:<uid>:<hmac>`
- `cb:notify:<on|off>:<uid>:<hmac>`
- `cb:leave:<confirm>:<uid>:<hmac>`

---

## 5. Ranks (–≤ —Ç–µ–∫—Å—Ç–µ –ø–æ—Å—Ç–æ–≤, –Ω–µ –≤ —Ç–∞–π—Ç–ª–µ)
- ü•â –ë—Ä–æ–Ω–∑–∞: 0‚Äì6 –º–µ—Å
- ü•à –°–µ—Ä–µ–±—Ä–æ: 6‚Äì12 –º–µ—Å
- ü•á –ó–æ–ª–æ—Ç–æ: 12‚Äì24 –º–µ—Å
- üíé –ü–ª–∞—Ç–∏–Ω–∞: 24+ –º–µ—Å
